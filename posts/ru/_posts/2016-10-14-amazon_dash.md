---
layout: post
lang: ru
ref: amazone_dash
title: "Умная wi-fi кнопка для Synology (amazon dash hack)"
comments: true
summary: ...хак для amazon button (dash)...
tags: [osx, amazon button, dash, python, docker, synology]
---

![](/images/amazon_dash.png)

## Общая идея

Вы приклеиваете эту кнопку на стену, и ее нажатия регистрируются в таблице Google.
Из этой таблицы можете строить любые графики.

Практика показывает, что это очень нравится детям и служит дополнительным мотиватором 
что-то регулярно делать (например, зарядку).

Да и взрослым во многих ситуациях гораздо проще нажать на аппаратную кнопку на стене,
чем доставать телефон, искать там нужное приложение, нажимать кнопку в нем.

## Решение 

Для решения этой задачи трудно найти более простое и дешевое решение, чем 
[кнопка от amazon](https://www.amazon.com/b/?ie=UTF8&node=10667898011).

Особенно, когда они на распродаже по $0.99. Обратите внимание, при распродажах этих кнопок amazon
не вешает объявление на главную страницу, как для других своих устройств. 
Я увидел объявление о распродаже, на которой купил свои кнопки, только когда уже зашел на 
страницу выбора кнопок с готовностью купить их по регулярной цене.

В общем и с регулярной стоимостью этих кнопок в $5 трудно конкурировать.
На [aliexpress](https://www.aliexpress.com) вы можете купить ESP8266 за $2 или более комфортную
в использовании NodeMCU за $4, но добавьте к ним корпус, светодиод, кнопку, батарейку, вооружитесь
паяльником на несколько часов..

Единственная неприятность - вам нужна подписка Amazon Prime, как для покупки кнопки, так и для
ее активации. Первый месяц она дается бесплатно, но далее стоит порядка $10 в месяц.

Для регистрации нажатий кнопки вам нужно приложение (сервер), который будет при нажатии кнопки добавлять данные
в таблицу Google. Я упаковал свое [приложение](https://github.com/masterandrey/docker-amazon-dash/) в 
[контейнер Docker](https://hub.docker.com/r/masterandrey/amazon-dash/) 
и у себя использую его на дисковом массиве [Synology](https://www.synology.com). 

Вы можете поставить его на любой постоянно включенный компьютер, где есть 
[docker](https://www.docker.com).
Обратите внимание, что если это macOS, docker работает в ней в виртуальной машине и поэтому
приложение из контейнера не сможет прослушивать сеть и надо его запускать вне контецйнера.

Чтобы использовать мое приложение вне docker, вам надо установить python3 и перечисленные
в [pip.requirements.txt](https://github.com/masterandrey/docker-amazon-dash/blob/master/pip.requirements.txt)
библиотеки и все необходимые для них системные зависимости.

## Подробнее о решении

Внутри кнопки от amazon достаточно мощный процессор ARM Cortex, если бы был простой способ 
использовать его с wifi обвязкой кнопки, то нам вовсе не нужен бы был никакой сервер, но пока не нашли 
возможности сделать с его помощью что-то более полезное, чем помигать светодиодом
(и даже этот трюк далеко не так просто сделать).

Поэтому мы ничего с кнопкой не делаем, мы используем ее достаточно тупо - обнаруживаем ее попытки
выйти в сеть и, если их видим, то считаем что кнопка нажата.

Мое [приложение](https://github.com/masterandrey/docker-amazon-dash) для прослушивания траффика 
в локальной сети использует python библиотеку [scapy](https://github.com/phaethon/scapy).
Для ее установки надо установить также несколько системных библиотек, но вам не надо об этом беспокоиться,
потому что я предоставляю docker контейнер, где все это уже сделано.

В сети есть немало альтернативных приложений, но я не смог найти удобной интеграции с google docs и 
готового контейнера docker для установки  на мой Synology, поэтому написал все это сам.

## Настройка кнопки

Для настройки у вас должна быть подписка Amazon Prime, иначе опции настройки вообще нет в приложении.
Даже если у вас ранее была подписка Prime и есть ранее купленные кнопки, когда подписка закончивается,
вы уже не сможете настраивать ваши кнопки.

Хорошая новость в том, что настройка очень проста, и ее надо сделать один раз.

Интерфейс приложения amazon постоянно меняется, но общий смысл в том что надо разместить телефон рядом 
с кнопкой и выбрать в приложении amazon `Your account` -> `Dash buttons and devices` -> 
`Set up a new device`.
Надо начать процесс настройки и прекратить его в тот момент, когда вам предложат выбрать приобретаемый 
продукт.
Выбирать продукт ни в коем случае не надо, иначе при нажатии кнопки автоматически будет создаваться
заказ в amazon.

Приложение пишет, что надо иметь под рукой пароль от wifi с которым будет соединения кнопка, но в моем
случае приложение так и не спрашивало у меня этот пароль, тем не менее кнопки успешно обнаруживаются
моим приложением.

Размещать телефон рядом с кнопкой надо потому, что телефон передает на нее данные через не слышимые
человеческим ухом звуки (возможно, это означает что надо выводить телефон из бесшумного режима и
не занижать сильно громкость, но я с этим не экспериментировал).

## Настройка прав таблицы google

Мое приложение ориентируется на определенную конфигурацию таблицы, поэтому вам будет проще скопировать
ее [образец](https://docs.google.com/spreadsheets/d/1m2NNfdKIb3JDieBZEBL5e15-6wx_BUf7rxyP2CwOekY/edit#gid=0).

Не забудьте перемеименовать ее после копирования - приложение ожидает что она называется `amazon_dash`.
При желании вы можете изменить это в исходном тесте (константа `DOC_NAME`).

После этого следует самая сложная часть настройки - в нечеловеческом интерфейсе google дать моему
приложению права работать с вашей копией этой таблицы.

Я не буду даже пытаться описать этот экзистенциальный опыт, отправляют вас в 
[инструкцию google](https://developers.google.com/sheets/api/quickstart/python) - вам нужно 
справиться с шагом 1, и да пребудет с вами сила.

В итоге вы получите json-файл с правами. Он содержит секрет для доступа к вашей таблице, поэтому не
выкладывайте его пожалуйста в интернете ;)

Не забудьте в интерфейсе Google Drive дать права на таблицу пользователю, от имени кторого работает
программа (его email есть в файле json).

Полученный json-файл надо переименовать в `amazone-dash-hack.json` и монтировать к контейнеру в каталоге
`/amazone-dash-private`. 

В Synology это делается через графический интерфейс.
Загрузите полученный от Goole файл под именем `amazone-dash-hack.json` 
в каталог `/amazone-dash-private` в любом удобном вам месте на Synology, и ниже в разделе
про настройку Synology описано, как подключить этот каталог к контейнеру.

Если же вы используете
docker из командной строки то вам надо положить `amazone-dash-hack.json` в каталог `amazone-dash-private` и 
добавить в командную строку docker:

        -v ./amazone-dash-private:/amazone-dash-private:ro

К сожалению, Google API работает просто нечеловечески медленно - добавление нажатия в таблицу может 
занимать несколько минут.

## Регистрация кнопки в приложении

Приложение должно знать, какой MAC-адрес соотвествует какой кнопке.
Для этого у него есть файл `buttons.json` который должен быть размещен в том же каталоге, где и файл
с правами к таблице Google.

Самый простой способ узнать MAC-адрес кнопки - зайти на встроенный в нее веб-сервер. Для этого надо
соединиться с WiFi сетью, создаеваемой **ненастроенной** кнопкой и называющейся `Button ConfigureMe`.
Открыть веб-страницу по адресу `http://192.168.0.1` и на ней будут все параметры кнопки, включая
MAC-адрес.

Альтернативный способ, который работает для уже настроенных кнопок (умеющих соединяться с вашим wifi)
- посмотреть адрес в логах моего приложения.
Оно один раз пишет в лог все встренные ей впервые MAC-адреса, так что адрес вашей кнопки после
ее нажатия скорее всего будет там последним. В Synology чтобы посмотреть лог надо открыть в окне `docker`
вкладку `container`, выбрать контейнер с моим приложением, нажать кнопку `Details` и в открывшемся окне
выбрать `log`.

Определенный вами MAC-адрес надо добавить в файл `buttons.json` и дать вашей кнопке любое название.
Приложение считывает этот файл при загрузке, поэтому после этого надо перезапустить контейнер docker
(выключить и включить переключатель справа в строке с контейнером в интерфейсе Synology).

## Как устроена таблица

На странице `press` этой таблицы регистрируется каждое обнаруженное нажатие известных (описанных в
`buttons.json`) кнопок. 

На странице `event` регистрируются интервалы времени с логикой, задаваемой для каждой кнопки параметрами
на странице `settings`. 

Программа пытается понять, не нажата ли кнопка повторно случайно, через слишком
 малый (параметр `restart`) интервал времени. 
В этом случае она регистрирует ее нажатие в `press`, но не меняет ничего в `event`.

Если кнопка нажата через слишком большой промежуток времени (параметр `autoclose`) то предыдущий интервал
закрывается с длительностью по умолчанию (`default`) и начинается новый. Это полезно для ситуаций,
когда, например, ребенок забыл нажать кнопку по окончании упражнений и предыдущий интервал остался
не закрытым, но понятно что его длительность была какая-то разумная, а не целый день до следующего занятия.

## Установка на Synology
Добавляем в docker image с моим приложением `https://hub.docker.com/r/masterandrey/amazon-dash/`:

![](/images/dash_synology_docker_image.png)
![](/images/dash_synology_docker_url.png)

Когда он скачается, чтобы создать из него контейнер, два раза кликните по нему.

Даем максимальные права контейнеру, потому что приложение прослушивает сетевой трафик:

![](/images/dash_synology_docker_general.png)

В `Advanced settings` -> `Volume` подключите каталог `/amazone-dash-private` с секретами доступа к 
таблице Google и настройками кнопок к контейнеру:

![](/images/dash_synology_docker_volume.png)

А в `Network` включите настройку `Use the same network as Docker host` чтобы приложение могло прослушивать
вашу сеть.

![](/images/dash_synology_docker_network.png)